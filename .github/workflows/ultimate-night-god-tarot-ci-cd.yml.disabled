name: ğŸŒ™ Ultimate Night God Tarot - CI/CD Pipeline

on:
  push:
    branches: 
      - main
      - develop
      - 'feature/*'
  pull_request:
    branches: 
      - main
      - develop

env:
  NODE_VERSION: '20.19.0'
  CACHE_KEY_PREFIX: night-god-tarot-v1

jobs:
  # ğŸ” Code Quality & Security Scan
  code-analysis:
    name: ğŸ” Code Quality & Security Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ” TypeScript Type Check
        run: npm run type-check

      - name: ğŸ§¹ ESLint Code Quality
        run: npm run lint

      - name: ğŸ” Security Audit
        run: npm audit --audit-level=high

      - name: ğŸ“Š Generate Coverage Report
        run: npm run test:coverage
        continue-on-error: true

      - name: ğŸ“ˆ Upload Coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false

  # ğŸ§ª Comprehensive Testing Suite
  testing:
    name: ğŸ§ª Testing Suite (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: code-analysis
    
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node-version: ['18.x', '20.x', '22.x']
        
    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ§ª Run Unit Tests
        run: npm test

      - name: ğŸ”§ Build Application
        run: npm run build

      - name: ğŸ§ª Test Monica AI Integration
        run: npm run test:monica-only
        env:
          MONICA_TEST_MODE: true
          VITE_MOCK_AI_RESPONSES: true

      - name: ğŸ“Š Test Build Size
        run: |
          echo "ğŸ“¦ Build Analysis:"
          du -sh dist/
          find dist/ -name "*.js" -exec du -h {} \; | head -5
          find dist/ -name "*.css" -exec du -h {} \; | head -5

  # ğŸ—ï¸ Production Build & Optimization
  build-production:
    name: ğŸ—ï¸ Production Build & Optimization
    runs-on: ubuntu-latest
    needs: [code-analysis, testing]
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ”§ Build Production Bundle
        run: npm run build
        env:
          NODE_ENV: production
          VITE_ENVIRONMENT: production

      - name: ğŸ“Š Bundle Analysis
        run: |
          echo "ğŸ¯ Production Bundle Analysis:"
          echo "================================"
          du -sh dist/
          echo ""
          echo "ğŸ“„ HTML Files:"
          find dist/ -name "*.html" -exec ls -lh {} \;
          echo ""
          echo "ğŸ¨ CSS Files:"
          find dist/ -name "*.css" -exec ls -lh {} \;
          echo ""
          echo "ğŸ“œ JavaScript Files:"
          find dist/ -name "*.js" -exec ls -lh {} \;
          echo ""
          echo "ğŸ–¼ï¸ Assets:"
          du -sh dist/assets/ 2>/dev/null || echo "No assets directory"

      - name: ğŸ“¦ Upload Production Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: night-god-tarot-production-build
          path: dist/
          retention-days: 30

      - name: ğŸ“Š Lighthouse CI Performance Audit
        uses: treosh/lighthouse-ci-action@v10
        with:
          configPath: './lighthouse.config.js'
          uploadArtifacts: true
          temporaryPublicStorage: true

  # ğŸš€ Deploy to GitHub Pages
  deploy-github-pages:
    name: ğŸš€ Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-production
    if: github.ref == 'refs/heads/main'
    
    permissions:
      contents: read
      pages: write
      id-token: write
    
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ”§ Build for GitHub Pages
        run: npm run build
        env:
          NODE_ENV: production
          VITE_ENVIRONMENT: github-pages
          VITE_BASE_URL: ${{ github.event.repository.name }}

      - name: ğŸ“„ Setup Pages
        uses: actions/configure-pages@v4

      - name: ğŸ“¦ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: dist/

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # ğŸ³ Build & Push Docker Image
  docker-build:
    name: ğŸ³ Docker Build & Push
    runs-on: ubuntu-latest
    needs: build-production
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ—ï¸ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/night-god-tarot:latest
            ${{ secrets.DOCKER_USERNAME }}/night-god-tarot:${{ github.sha }}
          labels: |
            org.opencontainers.image.title=Night God Tarot
            org.opencontainers.image.description=Ultimate AI-Powered Mystical Divination System
            org.opencontainers.image.url=https://github.com/${{ github.repository }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.version=${{ github.sha }}
            org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}

  # ğŸ“± Mobile App Build (if applicable)
  mobile-build:
    name: ğŸ“± Progressive Web App Build
    runs-on: ubuntu-latest
    needs: build-production
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ“‚ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ“± Build PWA
        run: npm run build
        env:
          VITE_PWA_MODE: true
          NODE_ENV: production

      - name: ğŸ” PWA Validation
        run: |
          echo "ğŸ” PWA Validation:"
          echo "=================="
          if [ -f "dist/manifest.json" ]; then
            echo "âœ… manifest.json found"
            cat dist/manifest.json | jq '.'
          else
            echo "âŒ manifest.json not found"
          fi
          
          if [ -f "dist/service-worker.js" ]; then
            echo "âœ… service-worker.js found"
          else
            echo "âŒ service-worker.js not found"
          fi

      - name: ğŸ“¦ Upload PWA Build
        uses: actions/upload-artifact@v4
        with:
          name: night-god-tarot-pwa
          path: dist/

  # ğŸ”” Notification System
  notify-success:
    name: ğŸ”” Success Notification
    runs-on: ubuntu-latest
    needs: [deploy-github-pages, docker-build, mobile-build]
    if: success() && github.ref == 'refs/heads/main'
    
    steps:
      - name: ğŸ‰ Send Success Notification
        run: |
          echo "ğŸŒ™âœ¨ ULTIMATE NIGHT GOD TAROT DEPLOYMENT SUCCESS âœ¨ğŸŒ™"
          echo "====================================================="
          echo "ğŸš€ GitHub Pages: Deployed successfully"
          echo "ğŸ³ Docker Image: Built and pushed"
          echo "ğŸ“± PWA Build: Generated successfully"
          echo "ğŸ”® Monica AI: Ready for mystical divination"
          echo "ğŸ´ 78 Tarot Cards: All integrated"
          echo "ğŸ“š 31ä¸‡å­— Novel: System active"
          echo "ğŸ† Achievement System: Operational"
          echo "====================================================="
          echo "âœ¨ The mystical universe awaits your users! âœ¨"

  # ğŸš¨ Failure Notification
  notify-failure:
    name: ğŸš¨ Failure Notification
    runs-on: ubuntu-latest
    needs: [code-analysis, testing, build-production]
    if: failure()
    
    steps:
      - name: ğŸš¨ Send Failure Notification
        run: |
          echo "ğŸš¨ NIGHT GOD TAROT BUILD FAILURE ğŸš¨"
          echo "=================================="
          echo "âŒ Build failed at: $(date)"
          echo "ğŸ” Check the logs above for details"
          echo "ğŸ“§ Notification sent to development team"
          echo "=================================="